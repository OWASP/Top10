# A1:2017 Внедрение

| Источники угроз/Векторы атак | Недостатки безопасности           | Последствия               |
| -- | -- | -- |
| Зависит от прил. : Сложность эксплуатации 3 | Распространенность 2 : Сложность обнаружения 3 | Технические 3 : Для бизнеса ?|
| Почти любой источник данных может оказаться вектором для внедрения: переменные окружения, параметры, внешние и внутренние веб-службы, а также все типы пользователей. [Внедрения](https://www.owasp.org/index.php/Injection_Flaws) становятся возможными, если злоумышленник может отправлять интерпретатору вредоносные данные. | Внедрения особенно распространены в старом коде. Уязвимости часто встречаются в SQL-, LDAP-, XPath- или NoSQL-запросах, системных командах, XML-обработчиках, SMTP-заголовках, языках выражений и ORM-запросах. Внедрения легко обнаружить при анализе кода. Сканеры и фаззеры могут помочь злоумышленникам найти подобные уязвимости. |Внедрения могут привести к потере данных, их повреждению или разглашению третьим лицам, а также к отказу в обслуживании. В некоторых случаях контроль над узлом может быть полностью перехвачен. Последствия для бизнеса зависят от статуса приложения и данных.|

## Является ли приложение уязвимым?

Приложение уязвимо, если:

* вводимые пользователем данные не проверяются, не фильтруются или не очищаются;
* динамические запросы или непараметризованные вызовы без контекстного экранирования напрямую используются в интерпретаторе;  
* вредоносные данные используются в поисковых параметрах объектно-реляционного отображения для извлечения дополнительной или критически важной информации;
* вредоносные данные используются или добавляются т.о., что SQL-код или команды содержат структурные и вредоносные данные в динамических запросах, командах или хранимых процедурах.

Наиболее распространенными являются SQL-, NoSQL-, ORM-, LDAP-, EL- или OGNL-внедрения, а также внедрения команд ОС. То же самое касается всех интерпретаторов. Анализ исходного кода является лучшим способом обнаружения внедрений, за которым следует полное автоматизированное тестирование всех вводимых параметров, заголовков, URL, куки, JSON-, SOAP- и XML-данных. Организации также могут включать в процесс непрерывной интеграции и развертывания ПО (CI/CD) статическое ([SAST](https://www.owasp.org/index.php/Source_Code_Analysis_Tools)) и динамическое ([DAST](https://www.owasp.org/index.php/Category:Vulnerability_Scanning_Tools)) тестирование кода и приложений для обнаружения новых уязвимостей перед внедрением приложений в производство.

### ORM | LDAP | EL | OGNL

* **ORM** - Объектно-реляционное отображение
* **LDAP** - Облегченный протокол доступа к каталогам
* **EL** - Язык выражений
* **OGNL** - Объектно-графовый язык навигации

## Как предотвратить

Для предотвращения внедрений необходимо изолировать данные от команд и запросов.

* Используйте безопасный API, исключающий применение интерпретатора или предоставляющий параметризованный интерфейс, либо используйте инструменты объектно-реляционного отображения (ORM).
__Примечание__: даже параметризованные хранимые процедуры могут привести к SQL-внедрениям, если PL/SQL или T-SQL позволяют присоединять запросы и данные или выполнять вредоносный код с помощью EXECUTE IMMEDIATE или exec().
* Реализуйте на сервере белые списки для проверки входных данных. Это, конечно, не обеспечит полную защиту, поскольку многие приложения используют спецсимволы, например, в текстовых областях или API для мобильных приложений.
* Для остальных динамических запросов реализуйте экранирование спецсимволов, используя соответствующий интерпретатору синтаксис.
__Примечание__: элементы SQL-структуры, такие как названия таблиц или столбцов, нельзя экранировать, поэтому предоставляемые пользователями названия представляют опасность. Это обычная проблема программ для составления отчетов.
* Используйте в запросах LIMIT или другие элементы управления SQL для предотвращения утечек данных.

## Примеры сценариев атак

**Сценарий №1**: Приложение использует недоверенные данные при создании следующего уязвимого SQL-вызова:

`String query = "SELECT * FROM accounts WHERE custID='" + request.getParameter("id") + "'";`

**Сценарий №2**: Безоговорочное доверие приложений к фреймворкам может привести к появлению уязвимых запросов (например, в языке запросов HQL):

`Query HQLQuery = session.createQuery("FROM accounts WHERE custID='" + request.getParameter("id") + "'");`

В обоих случаях злоумышленник изменяет в своем браузере значение параметра "id" для отправки ' UNION SELECT SLEEP(10);--. Например:

`http://example.com/app/accountView?id=' UNION SELECT SLEEP(10);--`

Изменение обоих запросов позволяет получить все записи из таблицы учетных данных. Более серьезные атаки позволяют изменить или удалить данные, а также вызвать хранимые процедуры.

## Ссылки

### OWASP

* [Проактивная защита OWASP: Параметризация запросов](https://www.owasp.org/index.php/OWASP_Proactive_Controls#2:_Parameterize_Queries)
* [Стандарт подтверждения безопасности приложений OWASP (ASVS): V5 Проверка входных данных и кодировки](https://www.owasp.org/index.php/ASVS_V5_Input_validation_and_output_encoding)
* [Руководство OWASP по тестированию: Внедрение SQL-кода](https://www.owasp.org/index.php/Testing_for_SQL_Injection_(OTG-INPVAL-005)), [команд](https://www.owasp.org/index.php/Testing_for_Command_Injection_(OTG-INPVAL-013)), [ORM](https://www.owasp.org/index.php/Testing_for_ORM_Injection_(OTG-INPVAL-007))
* [Памятка OWASP: Предотвращение внедрений](https://www.owasp.org/index.php/Injection_Prevention_Cheat_Sheet)
* [Памятка OWASP: Предотвращение SQL-внедрений](https://www.owasp.org/index.php/SQL_Injection_Prevention_Cheat_Sheet)
* [Памятка OWASP: Предотвращение внедрений в Java](https://www.owasp.org/index.php/Injection_Prevention_Cheat_Sheet_in_Java)
* [Памятка OWASP: Параметризация запросов](https://www.owasp.org/index.php/Query_Parameterization_Cheat_Sheet)
* [Справочник OWASP по автоматизированным атакам на веб-приложения – OAT-014](https://www.owasp.org/index.php/OWASP_Automated_Threats_to_Web_Applications)

### Сторонние

* [CWE-77: Внедрение команд](https://cwe.mitre.org/data/definitions/77.html)
* [CWE-89: Внедрение SQL](https://cwe.mitre.org/data/definitions/89.html)
* [CWE-564: Внедрение SQL-кода с использованием Hibernate](https://cwe.mitre.org/data/definitions/564.html)
* [CWE-917: Внедрение кода языка выражений](https://cwe.mitre.org/data/definitions/917.html)
* [PortSwigger: Внедрение в серверные шаблоны](https://portswigger.net/kb/issues/00101080_serversidetemplateinjection)