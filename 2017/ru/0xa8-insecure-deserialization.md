# A8:2017 Небезопасная десериализация

| Источники угроз/Векторы атак | Недостатки безопасности           | Последствия               |
| -- | -- | -- |
| Зависит от прил. : Сложность эксплуатации 1 | Распространенность 2 : Сложность обнаружения 2 | Технические 3 : Для бизнеса ? |
| Эксплуатировать десериализацию сложно, поскольку готовые эксплойты редко можно использовать без их изменения или доработки. | Данная уязвимость включена в Топ-10 по результатам [отраслевых исследований](https://owasp.blogspot.com/2017/08/owasp-top-10-2017-project-update.html) , а не по количественным показателям. Некоторые инструменты могут обнаруживать ошибки десериализации, но для их подтверждения обычно требуется участие специалиста. Ожидается, что по мере разработки новых инструментов обнаружения и устранения ошибок десериализации данных об их распространенности станет больше.  | Последствия ошибок десериализации нельзя недооценивать. Подобные ошибки могут привести к удаленному выполнению кода, одной из самых опасных уязвимостей. Последствия для бизнеса зависят от требований к защите приложения и данных. |

## Является ли приложение уязвимым?

Приложения и API уязвимы, если осуществляют десериализацию вредоносных или модифицированных объектов, предоставляемых злоумышленником.

Это позволяет осуществить два основных типа атак:

* атаки, связанные со структурой объектов и данных, когда злоумышленник изменяет логику приложения или удаленно выполняет произвольный код при наличии доступных приложению классов, поведение которых может меняться во время или после десериализации;
* атаки с подменой данных, например связанные с управлением доступом, когда используются существующие структуры данных, но изменяется содержимое.

Сериализация может использоваться в приложениях для:

* удаленного и межпроцессного взаимодействия (RPC/IPC);
* проводных протоколов, веб-служб, брокеров сообщений;
* кэширования или сохранения данных;
* баз данных, серверов кэширования, файловых систем;
* куки-файлов HTTP, параметров HTML-форм, токенов аутентификации API.

## Как предотвратить

Единственным безопасным решением будет игнорирование сериализованных объектов от недоверенных источников или использование среды сериализации, допускающей только примитивные типы данных.

Если это невозможно, рекомендуется следующее:

* Проверка целостности сериализованных объектов, например с помощью цифровых подписей, для предотвращения создания вредоносных объектов или подмены данных.
* Ввод строгих ограничений типов при десериализации перед созданием объекта, поскольку ожидаемым является поддающийся определению набор классов. Существуют методы обхода подобной защиты, поэтому полагаться исключительно на нее не рекомендуется.
* Изоляция и запуск кода, осуществляющего десериализацию, в среде с минимальными привилегиями, если это возможно.
* Журналирование исключений и ошибок десериализации, например непредусмотренных типов входных данных или исключений при десериализации.
* Ограничение или контроль входящих и исходящих сетевых подключений контейнеров или серверов, осуществляющих десериализацию.
* Отслеживание десериализации с предупреждением о фактах продолжительной десериализации.

## Примеры сценариев атак

**Сценарий №1**. React-приложение вызывает набор микрослужб Spring Boot. Будучи функциональными программистами, разработчики попытались обеспечить неизменяемость своего кода. Используемое ими решение заключается в сериализации состояния пользователя и передаче его с каждым запросом. Злоумышленник, заметивший подпись Java-объекта "rO0", может использовать Java Serial Killer для удаленного выполнения кода на сервере приложения.

**Сценарий №2**. На PHP-форуме используется сериализация PHP-объектов для хранения "суперкуки", содержащих идентификатор, роль, хеш пароля и другие данные пользователя:

```
a:4:{i:0;i:132;i:1;s:7:"Mallory";i:2;s:4:"user";i:3;s:32:"b6a8b3bea87fe0e05022f8f3c88bc960";}
```

Злоумышленник изменяет сериализованный объект, наделяя себя привилегиями администратора:

```
a:4:{i:0;i:1;i:1;s:5:"Alice";i:2;s:5:"admin";i:3;s:32:"b6a8b3bea87fe0e05022f8f3c88bc960";}
```

## Ссылки

### OWASP

* [Памятка OWASP: Десериализация](https://wiki.owasp.org/index.php/Deserialization_Cheat_Sheet)
* [Проактивная защита OWASP: Обязательная проверка всех входных данных](https://wiki.owasp.org/index.php/OWASP_Proactive_Controls#4:_Validate_All_Inputs)
* [Стандарт подтверждения безопасности приложений OWASP](https://wiki.owasp.org/index.php/Category:OWASP_Application_Security_Verification_Standard_Project#tab=Home)
* [OWASP AppSecEU 2016: Как пережить апокалипсис десериализации Java](https://speakerdeck.com/pwntester/surviving-the-java-deserialization-apocalypse)
* [OWASP AppSecUSA 2017: Пятница, 13-е — Джейсон под ударом](https://speakerdeck.com/pwntester/friday-the-13th-json-attacks)

### Сторонние

* [CWE-502: Десериализация недоверенных данных](https://cwe.mitre.org/data/definitions/502.html)
* [Безопасность десериализации Java](https://github.com/mbechler/marshalsec)
* [OWASP AppSec Cali 2015: Консервируем объекты](http://frohoff.github.io/appseccali-marshalling-pickles/)